<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>å®˜æ–¹æ´»åŠ¨</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="/css/toast.css">
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    /* åŠ è½½é¡µé¢æ ·å¼ */
    #loading-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #fff8f0; /* ä¸ä¸»é¢˜è‰²åŒ¹é…çš„èƒŒæ™¯ */
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: opacity 0.5s ease;
    }

    .loader-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
    }

    .loader-logo {
        width: 150px;
        height: auto;
        animation: bounce 2s infinite;
    }

    /* è¿›åº¦æ¡æ ·å¼ */
    .progress-container {
        width: 300px;
        height: 10px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin-top: 20px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
    }

    .progress-bar {
        width: 0%;
        height: 100%;
        background-color: #C07C59; /* ä¸»é¢˜è‰² */
        border-radius: 10px;
        transition: width 0.3s ease;
    }

    .progress-text {
        font-family: 'Arial', sans-serif;
        font-size: 18px;
        font-weight: bold;
        color: #C07C59;
        margin-top: 10px;
    }

    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
    }
  </style>
</head>
<body>
    <!-- åŠ è½½é¡µé¢ -->
    <div id="loading-screen">
        <div class="loader-content">
            <img src="/images/loading.png" alt="Loading..." class="loader-logo">
            <div class="progress-container">
                <div class="progress-bar" id="progress-bar"></div>
            </div>
            <div class="progress-text" id="progress-text">0%</div>
        </div>
    </div>

    <!-- èƒŒæ™¯è£…é¥° (çŒ«çˆª) -->
    <img src="/images/çŒ«çˆª.png" class="cat-paw-decoration" alt="Background Decoration">

    <script>
        // ç«‹å³æ‰§è¡Œï¼šæ£€æŸ¥ç¼“å­˜ï¼Œå¦‚æœæœ‰ç¼“å­˜åˆ™ç›´æ¥éšè—ï¼Œé˜²æ­¢é—ªçƒ
        (function() {
            if (localStorage.getItem('hajimi_events_visited')) {
                var loader = document.getElementById('loading-screen');
                if (loader) loader.style.display = 'none';
            }
        })();

        // åŠ è½½åŠ¨ç”»é€»è¾‘
        (function(){
            var loader = document.getElementById('loading-screen');
            // å¦‚æœloaderè¢«éšè—äº†ï¼Œå°±ä¸è·‘é€»è¾‘äº†
            if (!loader || loader.style.display === 'none') return;

            var progressBar = document.getElementById('progress-bar');
            var progressText = document.getElementById('progress-text');
            var progress = 0;
            var loadInterval;

            // å¯åŠ¨è¿›åº¦æ¡åŠ¨ç”»
            function startLoading() {
                loadInterval = setInterval(function() {
                    // éšæœºå¢åŠ è¿›åº¦ï¼Œæ¨¡æ‹ŸçœŸå®æ„Ÿ
                    var increment = Math.random() * 5; 
                    progress += increment;
                    
                    // åœ¨é¡µé¢å®Œå…¨åŠ è½½å‰ï¼Œé™åˆ¶åœ¨ 90%
                    if (document.readyState !== 'complete' && progress > 90) {
                        progress = 90;
                    }
                    
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(loadInterval);
                        finishLoading();
                    }
                    
                    updateUI(progress);
                }, 100);
            }

            function updateUI(val) {
                var p = Math.floor(val);
                if (progressBar) progressBar.style.width = p + '%';
                if (progressText) progressText.innerText = p + '%';
            }

            function finishLoading() {
                setTimeout(function() {
                    loader.style.opacity = '0';
                    setTimeout(function() {
                        loader.style.display = 'none';
                        localStorage.setItem('hajimi_events_visited', 'true');
                    }, 500);
                }, 200);
            }

            // å¼€å§‹åŠ¨ç”»
            startLoading();

            // ç›‘å¬é¡µé¢åŠ è½½å®Œæˆ
            window.addEventListener('load', function() {
                // é¡µé¢åŠ è½½å®Œæˆåï¼Œå¿«é€Ÿè·‘å®Œå‰©ä½™è¿›åº¦
                clearInterval(loadInterval);
                loadInterval = setInterval(function() {
                    progress += 5; 
                    if (progress >= 100) {
                        progress = 100;
                        clearInterval(loadInterval);
                        updateUI(progress);
                        finishLoading();
                    } else {
                        updateUI(progress);
                    }
                }, 20);
            });
        })();
    </script>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  (æ ‡å‡†åŒ–ç»“æ„) -->
    <nav class="navbar" id="navbar">
        <div class="container">
            <!-- å·¦ä¾§åŒºåŸŸï¼šLogo -->
            <a href="/" class="logo">
                <img src="/images/logo.png" alt="HAJIMI">
            </a>

            <!-- ä¸­é—´åŒºåŸŸï¼šå¯¼èˆªé“¾æ¥ -->
            <ul class="nav-menu">
                <li><a href="/" class="nav-link" data-i18n="nav_home">é¦–é¡µ</a></li>
                <li><a href="https://hajimi-theta.vercel.app/" target="_blank" class="nav-link" data-i18n="nav_culture">å“ˆåŸºç±³æ–‡åŒ–</a></li>
                <li class="has-submenu">
                    <a href="javascript:void(0);" class="nav-link"><span data-i18n="nav_ecosystem">å“ˆåŸºç±³ç”Ÿæ€</span> <i class="fas fa-caret-down"></i></a>
                    <ul class="submenu">
                        <li><a href="#" onclick="showPopup(event)" data-i18n="nav_concert">éŸ³ä¹ä¼š</a></li>
                        <li><a href="/external_web/hajimi_emoji/emoji.html" data-i18n="nav_emoji">å¤´åƒ</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="javascript:void(0);" class="nav-link"><span data-i18n="nav_foundation">åŸºé‡‘ä¼š</span> <i class="fas fa-caret-down"></i></a>
                    <ul class="submenu">
                        <li><a href="/external_web/hajimi_beneficence/index.html" data-i18n="nav_charity">æ…ˆå–„</a></li>
                        <li><a href="/external_web/hajimi_events/events.html" data-i18n="nav_activity">æ´»åŠ¨</a></li>
                    </ul>
                </li>
                <li class="has-submenu">
                    <a href="javascript:void(0);" class="nav-link"><span data-i18n="nav_community">ç¤¾åŒº</span> <i class="fas fa-caret-down"></i></a>
                    <ul class="submenu">
                        <li><a href="https://x.com/hajimi_CTO_BNB" target="_blank">Twitter</a></li>
                        <li><a href="https://t.me/BNB_Hajimiiii" target="_blank">TG</a></li>
                        <li><a href="https://www.tiktok.com/@hajimi_bnb" target="_blank">tiktok</a></li>
                    </ul>
                </li>
            </ul>

            <!-- å³ä¾§åŒºåŸŸï¼šè¯­è¨€åˆ‡æ¢ -->
            <div class="nav-right">
                <div class="lang-switch" id="lang-switch">
                    <span class="current-lang">ä¸­æ–‡</span>
                    <i class="fas fa-caret-down"></i>
                    <ul class="lang-dropdown">
                        <li data-lang="zh">ä¸­æ–‡</li>
                        <li data-lang="en">English</li>
                    </ul>
                </div>
            </div>

            <!-- æ±‰å ¡èœå•æŒ‰é’® -->
            <div class="menu-toggle" id="mobile-menu">
                <i class="fas fa-bars"></i>
            </div>
        </div>
    </nav>
  
  <main class="container" style="margin-top: 120px;">
    <div class="page-header-text">
      <h1 data-i18n="headerTitle"></h1>
      <p data-i18n="headerSubtitle"></p>
    </div>
    <div class="filters">
      <button class="filter-chip chip-all" data-filter="all">å…¨éƒ¨</button>
      <button class="filter-chip chip-limited" data-filter="limited">é™æ—¶</button>
      <button class="filter-chip chip-permanent" data-filter="permanent">å¸¸é©»</button>
      <button class="filter-chip chip-completed" data-filter="completed">å®Œç»“</button>
    </div>
    <div id="activity-grid" class="grid"></div>
    <div id="pagination" class="pagination"></div>
  </main>
  <!-- ç®€å•é¡µè„š -->
  <footer class="simple-footer">
      <p>Â© 2025 by Hajimi Community . All rights reserved!</p>
  </footer>
  <script src="events-nav.js"></script>
  <script>
    // å½“å‰è¯­è¨€ï¼Œé»˜è®¤ä¸­æ–‡
    let lang = localStorage.getItem('hajimi_lang') || 'zh';
    // å¤´éƒ¨ä¸å¯¼èˆªæ–‡æ¡ˆï¼ˆä¸­è‹±ï¼‰
    const i18n = {
      zh: {
        brand: 'å“ˆåŸºç±³æ´»åŠ¨', home: 'é¦–é¡µ', headerTitle: 'å“ˆåŸºç±³æ´»åŠ¨', headerSubtitle: 'å“ˆåŸºç±³ç”Ÿæ€æ´»åŠ¨æ­£åœ¨è¿›è¡Œä¸­ï¼Œç‚¹å‡»ä¸‹æ–¹å¡ç‰‡è®¿é—®è¯¦æƒ…', from: 'èµ·',
        filters: { all: 'å…¨éƒ¨', limited: 'é™æ—¶', permanent: 'å¸¸é©»', completed: 'å®Œç»“' }
      },
      en: {
        brand: 'Hajimi Events', home: 'Home', headerTitle: 'Hajimi Events', headerSubtitle: 'Hajimi ecosystem events are ongoing. Click cards below for details', from: 'from',
        filters: { all: 'All', limited: 'Limited', permanent: 'Permanent', completed: 'Completed' }
      }
    };
    // æ´»åŠ¨æ•°æ®ï¼šæ”¯æŒå¼€å§‹/ç»“æŸæ—¶é—´ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰ï¼ŒçŠ¶æ€ï¼šé™æ—¶/å¸¸é©»/å®Œç»“
    const events = [
      { title: { zh: 'å“ˆåŸºç±³å”±æ­Œå¤§èµ›S1', en: 'Hajimi Singing Contest S1' }, description: { zh: 'æ¥å”±æ­ŒğŸ¤å§ï¼Œå“ˆåŸºç±³å¥½å£°éŸ³', en: 'Letâ€™s sing ğŸ¤ â€” Hajimi Voice' }, image: 'images/1.jpg', url: 'https://x.com/hajimi_CTO_BNB/status/1990643902249120255', start: '2025-11-18', end: '2025-11-21', status: 'completed' },
      { title: { zh: 'æ‹¯æ•‘æµæµªè®¡åˆ’', en: 'Rescue Stray Plan' }, description: { zh: 'ä½ çš„å–„ä¸¾ï¼Œä¸æ˜¯æ–½èˆï¼Œæ˜¯æ‹¯æ•‘ã€‚è®©æ¯ä¸€åªå°çŒ«ï¼Œéƒ½æ‹¥æœ‰è¢«çˆ±çš„æƒåˆ©ï¼', en: 'Your kindness is rescue, not charity. Every cat deserves love!' }, image: 'images/2.png', url: 'https://x.com/hajimi_fund/status/1987769574113382594', start: '2025-11-10', status: 'permanent' }
    ];
    // ä»æœ¬åœ°å­˜å‚¨è¯»å–ç”¨æˆ·æ–°å¢çš„æ´»åŠ¨
    function getUserEvents() {
      try {
        const raw = localStorage.getItem('user_events');
        if (!raw) return [];
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr : [];
      } catch (_) { return []; }
    }
    // è¿œç¨‹ events.jsonï¼ˆéƒ¨ç½²åˆ°äº‘ç«¯æ—¶ç”¨äºåŒæ­¥æœ€æ–°æ´»åŠ¨ï¼‰
    let remoteEvents = null;
    async function fetchRemoteEvents() {
      try {
        const res = await fetch('events.json?v=' + Date.now(), { cache: 'no-store' });
        if (!res.ok) return;
        const data = await res.json();
        if (Array.isArray(data)) remoteEvents = data;
      } catch (_) { /* ç½‘ç»œå¼‚å¸¸åˆ™å¿½ç•¥ */ }
    }
    // æ´»åŠ¨ç½‘æ ¼å®¹å™¨
    const grid = document.getElementById('activity-grid');
    function setTexts() {
      // è®¾ç½®å¸¦ data-i18n çš„å…ƒç´ æ–‡æœ¬
      document.querySelectorAll('[data-i18n]').forEach(el => {
        // Skip navbar elements as they are handled by events-nav.js
        if (el.closest('.navbar')) return;

        const k = el.getAttribute('data-i18n');
        if (i18n[lang] && i18n[lang][k]) {
            el.textContent = i18n[lang][k];
        }
      });
      // æ›´æ–°ç­›é€‰æŒ‰é’®æ–‡æ¡ˆï¼ˆå…¨éƒ¨/é™æ—¶/å¸¸é©»/å®Œç»“ï¼‰
      const f = i18n[lang].filters;
      const chipAll = document.querySelector('.chip-all'); if (chipAll) chipAll.textContent = f.all;
      const chipLimited = document.querySelector('.chip-limited'); if (chipLimited) chipLimited.textContent = f.limited;
      const chipPermanent = document.querySelector('.chip-permanent'); if (chipPermanent) chipPermanent.textContent = f.permanent;
      const chipCompleted = document.querySelector('.chip-completed'); if (chipCompleted) chipCompleted.textContent = f.completed;
    }
    // çŠ¶æ€æ ‡ç­¾æ–‡æ¡ˆ
    const statusText = {
      zh: { permanent: 'å¸¸é©»', limited: 'é™æ—¶', completed: 'å®Œç»“' },
      en: { permanent: 'Permanent', limited: 'Limited', completed: 'Completed' }
    };
    // è§£æåŒ—äº¬æ—¶é—´åˆ°æ¯«ç§’æ—¶é—´æˆ³ï¼ˆä»…æ—¥æœŸåˆ™æŒ‰ 00:00ï¼‰
    function parseBJ(dateStr) {
      if (!dateStr) return null;
      const s = String(dateStr).trim();
      const parts = s.split(/\s+/);
      const d = parts[0].replace(/\//g, '-');
      const t = parts[1] ? parts[1] : '00:00';
      const iso = `${d}T${t}:00+08:00`;
      const ms = Date.parse(iso);
      return Number.isFinite(ms) ? ms : null;
    }
    // è®¡ç®—åŠ¨æ€çŠ¶æ€ï¼šè¶…è¿‡ç»“æŸæ—¶é—´åˆ™è§†ä¸ºå®Œç»“
    function effectiveStatus(item, nowMs) {
      const endMs = parseBJ(item.end);
      if (endMs && nowMs >= endMs) return 'completed';
      return item.status;
    }
    // æ ¼å¼åŒ–æ˜¾ç¤ºä¸º YYYY/MM/DDï¼ˆä¸å«æ—¶é—´ï¼‰
    function fmtFull(d) {
      if (!d) return '';
      const dt = new Date(d);
      const y = dt.getFullYear();
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${y}/${m}/${day}`;
    }
    function formatRange(start, end) {
      // ç»“æŸå­˜åœ¨åˆ™æ˜¾ç¤ºå®Œæ•´èŒƒå›´ï¼›å¦åˆ™æ˜¾ç¤ºâ€œèµ·â€
      const sFull = fmtFull(start);
      if (end) {
        const eFull = fmtFull(end);
        return `${sFull} - ${eFull}`;
      }
      return lang === 'zh' ? `${sFull}${i18n[lang].from}` : `${i18n[lang].from} ${sFull}`;
    }
    // æ¸²æŸ“å•å¼ å¡ç‰‡
    function renderCard(item) {
      const a = document.createElement('a');
      a.className = 'card';
      a.href = item.url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.setAttribute('aria-label', item.title[lang]);
      const img = document.createElement('img');
      img.src = item.image;
      img.alt = item.title[lang];
      const content = document.createElement('div');
      content.className = 'card-content';
      const h3 = document.createElement('h3');
      h3.textContent = item.title[lang];
      const p = document.createElement('p');
      p.textContent = item.description[lang];
      const meta = document.createElement('div');
      meta.className = 'card-meta';
      meta.textContent = formatRange(item.start, item.end);
      // æ ¹æ®å½“å‰æ—¶é—´è®¡ç®—çŠ¶æ€å¹¶æ˜¾ç¤ºå¾½ç« 
      const nowMs = Date.now();
      const st = effectiveStatus(item, nowMs);
      const badge = document.createElement('div');
      badge.className = `badge badge-${st}`;
      badge.textContent = statusText[lang][st];
      content.appendChild(h3);
      content.appendChild(p);
      content.appendChild(meta);
      a.appendChild(img);
      a.appendChild(badge);
      a.appendChild(content);
      return a;
    }
    // å½“å‰ç­›é€‰çŠ¶æ€ä¸å†…å®¹é«˜åº¦åŸºçº¿
    let filterStatus = null;
    let baseContentHeight = 0;
    
    // Pagination variables
    let currentPage = 1;
    const itemsPerPage = 12; // 4 columns * 3 rows = 12 items

    // æ’åºï¼šçŠ¶æ€ä¼˜å…ˆçº§ + åŒç±»æŒ‰å¼€å§‹æ—¶é—´æœ€è¿‘åœ¨å‰
    function sortEvents(list, nowMs) {
      const pri = { limited: 0, permanent: 1, completed: 2 };
      return list.slice().sort((a,b) => {
        const ap = pri[effectiveStatus(a, nowMs)], bp = pri[effectiveStatus(b, nowMs)];
        if (ap !== bp) return ap - bp;
        const ad = parseBJ(a.start) || 0;
        const bd = parseBJ(b.start) || 0;
        return bd - ad;
      });
    }

    function renderEvents() {
      // æ‰¹é‡æ¸²æŸ“ï¼Œä½¿ç”¨ DocumentFragment å‡å°‘é‡æ’
      grid.innerHTML = '';
      const paginationContainer = document.getElementById('pagination');
      if (paginationContainer) paginationContainer.innerHTML = '';

      const nowMs = Date.now();
      const base = remoteEvents || [];
      const filteredList = sortEvents((filterStatus ? base.filter(e => effectiveStatus(e, nowMs) === filterStatus) : base), nowMs);
      
      // Calculate total pages
      const totalPages = Math.ceil(filteredList.length / itemsPerPage);
      
      // Ensure currentPage is valid
      if (currentPage > totalPages) currentPage = totalPages || 1;
      if (currentPage < 1) currentPage = 1;

      // Slice list for current page
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const list = filteredList.slice(startIndex, endIndex);

      const frag = document.createDocumentFragment();
      list.forEach(e => frag.appendChild(renderCard(e)));
      grid.appendChild(frag);
      
      // Render pagination if needed
      if (totalPages > 1) {
          renderPagination(totalPages);
      }

      const h = equalizeCardContentHeights();
      if (!filterStatus) baseContentHeight = Math.max(baseContentHeight, h);
    }

    function renderPagination(totalPages) {
        const paginationContainer = document.getElementById('pagination');
        if (!paginationContainer) return;

        // Previous Button
        const prevBtn = document.createElement('button');
        prevBtn.textContent = '<';
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentPage--;
                renderEvents();
                window.scrollTo({ top: document.querySelector('.filters').offsetTop - 100, behavior: 'smooth' });
            }
        };
        paginationContainer.appendChild(prevBtn);

        // Page Numbers
        for (let i = 1; i <= totalPages; i++) {
            const btn = document.createElement('button');
            btn.textContent = i;
            if (i === currentPage) btn.classList.add('active');
            btn.onclick = () => {
                currentPage = i;
                renderEvents();
                window.scrollTo({ top: document.querySelector('.filters').offsetTop - 100, behavior: 'smooth' });
            };
            paginationContainer.appendChild(btn);
        }

        // Next Button
        const nextBtn = document.createElement('button');
        nextBtn.textContent = '>';
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderEvents();
                window.scrollTo({ top: document.querySelector('.filters').offsetTop - 100, behavior: 'smooth' });
            }
        };
        paginationContainer.appendChild(nextBtn);
    }

    function setLang(l) {
      // åˆ‡æ¢è¯­è¨€å¹¶åˆ·æ–°é¡µé¢æ–‡æœ¬ä¸å¡ç‰‡
      lang = l;
      localStorage.setItem('hajimi_lang', l);
      setTexts();
      renderEvents();
    }
    // Expose for events-nav.js
    window.setPageLanguage = setLang;
    
    function equalizeCardContentHeights() {
      // ç»Ÿä¸€æ‰€æœ‰å¡ç‰‡å†…å®¹åŒºé«˜åº¦ï¼Œé¿å…ç­›é€‰æ—¶è·³åŠ¨
      const boxes = Array.from(document.querySelectorAll('.card-content'));
      boxes.forEach(b => { b.style.height = ''; });
      if (!boxes.length) return 0;
      const maxH = Math.max(...boxes.map(b => b.offsetHeight));
      const target = Math.max(baseContentHeight, maxH);
      boxes.forEach(b => { b.style.height = target + 'px'; });
      return target;
    }
    let resizeTimer;
    window.addEventListener('resize', () => {
      // é˜²æŠ–ï¼šçª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—é«˜åº¦
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(equalizeCardContentHeights, 150);
    });
    const chips = Array.from(document.querySelectorAll('.filter-chip'));
    chips.forEach(chip => {
      chip.addEventListener('click', () => {
        chip.classList.add('feedback');
        setTimeout(() => { chip.classList.remove('feedback'); }, 400);
        const val = chip.getAttribute('data-filter');
        if (val === 'all') {
          filterStatus = null;
          chips.forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
        } else if (filterStatus === val) {
          filterStatus = null;
          chips.forEach(c => c.classList.remove('active'));
          const allChip = document.querySelector('.chip-all');
          if (allChip) allChip.classList.add('active');
        } else {
          filterStatus = val;
          chips.forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
        }
        // é‡ç½®é¡µç 
        currentPage = 1;
        // åˆ‡æ¢ç­›é€‰åé‡æ–°æ¸²æŸ“ä¸å¯¹é½é«˜åº¦
        renderEvents();
      });
    });
    const allChip = document.querySelector('.chip-all');
    if (allChip) allChip.classList.add('active');
    fetchRemoteEvents().finally(() => { setLang(lang); });
    // æ¯åˆ†é’Ÿè‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ï¼Œä»¥æ›´æ–°å®Œç»“çŠ¶æ€
    setInterval(renderEvents, 60000);
  </script>
</body>
</html>
